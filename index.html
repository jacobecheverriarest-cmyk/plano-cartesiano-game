<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plano Cartesiano - Game Boy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #8B8C89 0%, #6B6C6A 50%, #4A4A48 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
        }

        .gameboy {
            width: 100%;
            max-width: 400px;
            background: linear-gradient(145deg, #9B9D9A, #8B8C89);
            border-radius: 15px 15px 40px 40px;
            padding: 20px;
            box-shadow: 
                inset -5px -5px 15px rgba(0,0,0,0.3),
                inset 5px 5px 15px rgba(255,255,255,0.1),
                0 20px 40px rgba(0,0,0,0.4);
        }

        .screen-container {
            background: linear-gradient(145deg, #7A7B78, #6A6B68);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 
                inset 3px 3px 8px rgba(0,0,0,0.4),
                inset -3px -3px 8px rgba(255,255,255,0.05);
        }

        .screen {
            background: #9BBC0F;
            border-radius: 5px;
            padding: 10px;
            min-height: 450px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            color: #0F380F;
        }

        .nintendo-text {
            text-align: center;
            color: #4A4A48;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
        }

        .menu-screen {
            text-align: center;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 12px;
            margin-bottom: 20px;
        }

        .stats-display {
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(145deg, #7A7B78, #6A6B68);
            border: none;
            border-radius: 8px;
            padding: 12px;
            margin: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #2A2A28;
            cursor: pointer;
            box-shadow: 
                3px 3px 6px rgba(0,0,0,0.3),
                -2px -2px 6px rgba(255,255,255,0.1);
            text-shadow: 1px 1px 0 rgba(255,255,255,0.2);
        }

        .btn:active {
            box-shadow: 
                inset 2px 2px 4px rgba(0,0,0,0.3),
                inset -1px -1px 4px rgba(255,255,255,0.1);
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: 0.5;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 0 10px;
        }

        .dpad {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .dpad-btn {
            position: absolute;
            background: linear-gradient(145deg, #3A3B38, #2A2B28);
            border: none;
            width: 30px;
            height: 30px;
            font-size: 16px;
            color: #1A1A18;
            cursor: pointer;
            box-shadow: 
                2px 2px 4px rgba(0,0,0,0.4),
                -1px -1px 3px rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dpad-btn:active {
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5);
            transform: scale(0.95);
        }

        .dpad-up {
            top: 0;
            left: 35px;
            border-radius: 5px 5px 0 0;
        }

        .dpad-down {
            bottom: 0;
            left: 35px;
            border-radius: 0 0 5px 5px;
        }

        .dpad-left {
            left: 0;
            top: 35px;
            border-radius: 5px 0 0 5px;
        }

        .dpad-right {
            right: 0;
            top: 35px;
            border-radius: 0 5px 5px 0;
        }

        .dpad-center {
            left: 35px;
            top: 35px;
            width: 30px;
            height: 30px;
            background: linear-gradient(145deg, #5A5B58, #4A4B48);
            cursor: default;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(145deg, #8A3B3B, #6A2B2B);
            border: none;
            color: #4A1B1B;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                3px 3px 6px rgba(0,0,0,0.4),
                -2px -2px 4px rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:active {
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.5);
            transform: scale(0.95);
        }

        .game-screen {
            display: none;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .canvas-wrapper {
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 5px;
            margin: 10px 0;
        }

        #gameCanvas {
            width: 100%;
            height: auto;
            display: block;
            image-rendering: pixelated;
        }

        .message {
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            min-height: 30px;
            padding: 5px;
            margin-top: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .records-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .record-item {
            padding: 5px;
            margin: 3px 0;
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #9BBC0F;
            color: #0F380F;
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            text-align: center;
            font-family: 'Courier New', monospace;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .modal-stats {
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 16px;
        }

        .speaker-holes {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
        }

        .speaker-hole {
            width: 4px;
            height: 4px;
            background: #3A3B38;
            border-radius: 50%;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div class="gameboy">
        <div class="nintendo-text">NINTENDO GAME BOY</div>
        
        <div class="screen-container">
            <div class="screen">
                <!-- MEN√ö PRINCIPAL -->
                <div id="menuScreen" class="menu-screen">
                    <div class="title">üéÆ PLANO<br>CARTESIANO</div>
                    <div class="subtitle">AVENTURA MATEM√ÅTICA</div>
                    
                    <div class="stats-display">
                        üí∞ CR√âDITOS: <span id="menuCredits">0</span>
                    </div>
                    
                    <button class="btn" onclick="agregarCredito()" style="width: 90%;">
                        üí∞ INSERTAR MONEDA
                    </button>
                    <button class="btn" id="startBtn" onclick="iniciarJuego()" disabled style="width: 90%;">
                        ‚ñ∂Ô∏è START
                    </button>
                    
                    <div style="margin-top: 15px; font-size: 10px;">
                        <div style="font-weight: bold; margin: 10px 0;">INSTRUCCIONES:</div>
                        <div style="text-align: left; padding: 0 20px;">
                            ‚Ä¢ Llega a la ‚≠ê<br>
                            ‚Ä¢ Evita los üëæ<br>
                            ‚Ä¢ Tiempo: 2:30<br>
                            ‚Ä¢ 3 vidas
                        </div>
                    </div>
                    
                    <button class="btn" onclick="mostrarRecords()" style="width: 90%; margin-top: 10px;">
                        üèÜ R√âCORDS
                    </button>
                </div>

                <!-- PANTALLA DE JUEGO -->
                <div id="gameScreen" class="game-screen">
                    <div class="game-info">
                        <div>NIV:<span id="nivel">1</span></div>
                        <div>PTS:<span id="puntos">0</span></div>
                        <div>‚è±Ô∏è<span id="tiempo">2:30</span></div>
                        <div id="vidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    </div>
                    
                    <div class="canvas-wrapper">
                        <canvas id="gameCanvas" width="300" height="300"></canvas>
                    </div>
                    
                    <div style="font-size: 10px; display: flex; justify-content: space-between; margin-top: 5px;">
                        <div>TU:(<span id="posicion">0,0</span>)</div>
                        <div>OBJ:(<span id="objetivo">3,2</span>)</div>
                    </div>
                    
                    <div class="message" id="mensaje"></div>
                </div>
            </div>
        </div>

        <!-- CONTROLES GAME BOY -->
        <div class="controls">
            <div class="dpad">
                <button class="dpad-btn dpad-up" onclick="moverJugador(0, 1)">‚ñ≤</button>
                <button class="dpad-btn dpad-down" onclick="moverJugador(0, -1)">‚ñº</button>
                <button class="dpad-btn dpad-left" onclick="moverJugador(-1, 0)">‚óÑ</button>
                <button class="dpad-btn dpad-right" onclick="moverJugador(1, 0)">‚ñ∫</button>
                <div class="dpad-btn dpad-center"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="pedirAyuda()" id="ayudaBtn">H</button>
                <button class="action-btn" onclick="reiniciarPosicion()">R</button>
            </div>
        </div>

        <div class="speaker-holes">
            <div class="speaker-hole"></div>
            <div class="speaker-hole"></div>
            <div class="speaker-hole"></div>
            <div class="speaker-hole"></div>
            <div class="speaker-hole"></div>
            <div class="speaker-hole"></div>
        </div>
    </div>

    <!-- MODAL PANTALLA FINAL -->
    <div class="modal-overlay" id="modalFinal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitulo">GAME OVER</div>
            <div class="modal-stats" id="modalStats"></div>
            <button class="btn" onclick="cerrarModal()" style="width: 100%;">VOLVER AL MEN√ö</button>
        </div>
    </div>

    <!-- MODAL R√âCORDS -->
    <div class="modal-overlay" id="modalRecords">
        <div class="modal-content">
            <div class="modal-title">üèÜ R√âCORDS</div>
            <div class="records-list" id="listaRecords"></div>
            <button class="btn" onclick="cerrarModalRecords()" style="width: 100%;">CERRAR</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let juego = {
            nivel: 1,
            puntos: 0,
            posicion: { x: 0, y: 0 },
            objetivo: { x: 3, y: 2 },
            movimientos: [],
            vidas: 3,
            creditos: 0,
            enemigos: [],
            tiempoRestante: 150,
            juegoActivo: false,
            mostrarAyuda: false,
            records: JSON.parse(localStorage.getItem('recordsPlanoCartesiano')) || [],
            modoDificil: false,
            mensajeDificultad: ''
        };

        let intervalos = {
            enemigos: null,
            tiempo: null
        };

        const tiposEnemigos = [
            { emoji: 'üëæ', color: '#0F380F', tipo: 'perseguidor' },
            { emoji: 'üëπ', color: '#0F380F', tipo: 'emboscador' },
            { emoji: 'üëª', color: '#0F380F', tipo: 'errante' },
            { emoji: 'ü§ñ', color: '#0F380F', tipo: 'aleatorio' }
        ];

        function agregarCredito() {
            juego.creditos++;
            document.getElementById('menuCredits').textContent = juego.creditos;
            document.getElementById('startBtn').disabled = false;
        }

        function iniciarJuego() {
            if (juego.creditos <= 0) return;
            
            juego.creditos--;
            juego.nivel = 1;
            juego.puntos = 0;
            juego.vidas = 3;
            juego.posicion = { x: 0, y: 0 };
            juego.objetivo = { x: 3, y: 2 };
            juego.movimientos = [];
            juego.tiempoRestante = 150;
            juego.juegoActivo = true;
            juego.mostrarAyuda = false;
            
            generarEnemigos();
            
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            iniciarTimers();
            actualizarUI();
            dibujar();
        }

        function generarEnemigos() {
            juego.enemigos = [];
            const cantidad = Math.min(juego.nivel, 4);
            
            for (let i = 0; i < cantidad; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 11) - 5;
                    y = Math.floor(Math.random() * 11) - 5;
                } while ((x === 0 && y === 0) || (x === juego.objetivo.x && y === juego.objetivo.y));
                
                const tipo = tiposEnemigos[i];
                juego.enemigos.push({
                    x: x,
                    y: y,
                    tipo: tipo,
                    activo: true
                });
            }
        }

        function generarNuevoObjetivo() {
            const rango = Math.min(4 + Math.floor(juego.nivel / 2), 5);
            juego.objetivo.x = Math.floor(Math.random() * (rango * 2 + 1)) - rango;
            juego.objetivo.y = Math.floor(Math.random() * (rango * 2 + 1)) - rango;
            juego.mostrarAyuda = false;
        }

        function iniciarTimers() {
            detenerTimers();
            
            intervalos.tiempo = setInterval(() => {
                if (juego.juegoActivo && juego.tiempoRestante > 0) {
                    juego.tiempoRestante--;
                    actualizarUI();
                    
                    if (juego.tiempoRestante === 0) {
                        finalizarJuego('‚è∞ TIEMPO AGOTADO');
                    }
                }
            }, 1000);
            
            const velocidad = Math.max(200, 700 - (juego.nivel * 50));
            
            intervalos.enemigos = setInterval(() => {
                if (juego.juegoActivo) {
                    moverEnemigos();
                    verificarColisiones();
                    dibujar();
                }
            }, velocidad);
        }

        function detenerTimers() {
            if (intervalos.tiempo) clearInterval(intervalos.tiempo);
            if (intervalos.enemigos) clearInterval(intervalos.enemigos);
        }

        function moverEnemigos() {
            juego.enemigos.forEach(enemigo => {
                if (!enemigo.activo) return;
                
                const dx = juego.posicion.x - enemigo.x;
                const dy = juego.posicion.y - enemigo.y;
                
                let nuevoX = enemigo.x;
                let nuevoY = enemigo.y;
                
                if (enemigo.tipo.tipo === 'perseguidor') {
                    if (juego.nivel >= 5 && Math.abs(dx) > 0 && Math.abs(dy) > 0) {
                        nuevoX += dx > 0 ? 1 : -1;
                        nuevoY += dy > 0 ? 1 : -1;
                    } else {
                        if (Math.abs(dx) > Math.abs(dy)) {
                            nuevoX += dx > 0 ? 1 : -1;
                        } else {
                            nuevoY += dy > 0 ? 1 : -1;
                        }
                    }
                } else if (Math.abs(dx) > Math.abs(dy)) {
                    nuevoX += dx > 0 ? 1 : -1;
                } else {
                    nuevoY += dy > 0 ? 1 : -1;
                }
                
                enemigo.x = Math.max(-5, Math.min(5, nuevoX));
                enemigo.y = Math.max(-5, Math.min(5, nuevoY));
            });
        }

        function verificarColisiones() {
            const colision = juego.enemigos.some(e => 
                e.activo && e.x === juego.posicion.x && e.y === juego.posicion.y
            );
            
            if (colision) {
                juego.vidas--;
                document.getElementById('mensaje').textContent = 'üí• COLISI√ìN! -1 VIDA';
                
                if (juego.vidas <= 0) {
                    finalizarJuego('üéÆ GAME OVER');
                } else {
                    juego.posicion = { x: 0, y: 0 };
                    juego.movimientos = [];
                    actualizarUI();
                    setTimeout(() => {
                        if (juego.juegoActivo) {
                            document.getElementById('mensaje').textContent = '';
                        }
                    }, 2000);
                }
            }
        }

        function moverJugador(dx, dy) {
            if (!juego.juegoActivo) return;
            
            const nuevoX = juego.posicion.x + dx;
            const nuevoY = juego.posicion.y + dy;
            
            if (nuevoX < -5 || nuevoX > 5 || nuevoY < -5 || nuevoY > 5) return;
            
            const colision = juego.enemigos.some(e => 
                e.activo && e.x === nuevoX && e.y === nuevoY
            );
            
            if (colision) {
                juego.vidas--;
                document.getElementById('mensaje').textContent = 'üí• COLISI√ìN! -1 VIDA';
                
                if (juego.vidas <= 0) {
                    finalizarJuego('üéÆ GAME OVER');
                } else {
                    juego.posicion = { x: 0, y: 0 };
                    juego.movimientos = [];
                    actualizarUI();
                    setTimeout(() => {
                        if (juego.juegoActivo) {
                            document.getElementById('mensaje').textContent = '';
                        }
                    }, 2000);
                }
                return;
            }
            
            juego.posicion.x = nuevoX;
            juego.posicion.y = nuevoY;
            juego.movimientos.push({ x: nuevoX, y: nuevoY });
            
            if (nuevoX === juego.objetivo.x && nuevoY === juego.objetivo.y) {
                const puntosGanados = juego.nivel * 10;
                juego.puntos += puntosGanados;
                document.getElementById('mensaje').textContent = '‚≠ê +' + puntosGanados + ' PTS!';
                
                setTimeout(() => {
                    if (juego.juegoActivo) {
                        juego.nivel++;
                        generarNuevoObjetivo();
                        juego.posicion = { x: 0, y: 0 };
                        juego.movimientos = [];
                        
                        detenerTimers();
                        generarEnemigos();
                        iniciarTimers();
                        
                        document.getElementById('mensaje').textContent = 'NIVEL ' + juego.nivel;
                        actualizarUI();
                        dibujar();
                        
                        setTimeout(() => {
                            if (juego.juegoActivo) {
                                document.getElementById('mensaje').textContent = '';
                            }
                        }, 1500);
                    }
                }, 1000);
            }
            
            actualizarUI();
            dibujar();
        }

        function pedirAyuda() {
            if (juego.vidas > 0 && !juego.mostrarAyuda && juego.juegoActivo) {
                juego.mostrarAyuda = true;
                juego.vidas--;
                actualizarUI();
                dibujar();
            }
        }

        function reiniciarPosicion() {
            if (!juego.juegoActivo) return;
            juego.posicion = { x: 0, y: 0 };
            juego.movimientos = [];
            actualizarUI();
            dibujar();
        }

        function finalizarJuego(mensaje) {
            juego.juegoActivo = false;
            detenerTimers();
            guardarRecord();
            mostrarPantallaFinal(mensaje);
        }

        function guardarRecord() {
            const tiempo = 150 - juego.tiempoRestante;
            const record = {
                puntos: juego.puntos,
                nivel: juego.nivel,
                tiempo: formatearTiempo(tiempo),
                fecha: new Date().toLocaleDateString('es-ES')
            };
            
            juego.records.push(record);
            juego.records.sort((a, b) => b.puntos - a.puntos);
            juego.records = juego.records.slice(0, 10);
            localStorage.setItem('recordsPlanoCartesiano', JSON.stringify(juego.records));
        }

        function mostrarPantallaFinal(mensaje) {
            const tiempo = 150 - juego.tiempoRestante;
            document.getElementById('modalTitulo').textContent = mensaje;
            document.getElementById('modalStats').innerHTML = `
                <div style="margin: 10px 0;">üèÜ PUNTOS: ${juego.puntos}</div>
                <div style="margin: 10px 0;">üìä NIVEL: ${juego.nivel}</div>
                <div style="margin: 10px 0;">‚è±Ô∏è TIEMPO: ${formatearTiempo(tiempo)}</div>
            `;
            document.getElementById('modalFinal').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalFinal').style.display = 'none';
            volverAlMenu();
        }

        function mostrarRecords() {
            let html = '';
            if (juego.records.length === 0) {
                html = '<div style="text-align: center; padding: 20px;">¬°Sin r√©cords a√∫n!</div>';
            } else {
                juego.records.forEach((r, i) => {
                    const medalla = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}.`;
                    html += `
                        <div class="record-item">
                            <span>${medalla}</span>
                            <span>${r.puntos}pts</span>
                            <span>Nv.${r.nivel}</span>
                            <span>${r.tiempo}</span>
                        </div>
                    `;
                });
            }
            document.getElementById('listaRecords').innerHTML = html;
            document.getElementById('modalRecords').style.display = 'flex';
        }

        function cerrarModalRecords() {
            document.getElementById('modalRecords').style.display = 'none';
        }

        function volverAlMenu() {
            detenerTimers();
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('menuCredits').textContent = juego.creditos;
            document.getElementById('startBtn').disabled = juego.creditos === 0;
        }

        function formatearTiempo(seg) {
            const min = Math.floor(seg / 60);
            const s = seg % 60;
            return `${min}:${s.toString().padStart(2, '0')}`;
        }

        function actualizarUI() {
            document.getElementById('nivel').textContent = juego.nivel;
            document.getElementById('puntos').textContent = juego.puntos;
            document.getElementById('vidas').textContent = juego.vidas > 0 ? '‚ù§Ô∏è'.repeat(juego.vidas) : 'üíî';
            document.getElementById('posicion').textContent = `${juego.posicion.x},${juego.posicion.y}`;
            document.getElementById('objetivo').textContent = `${juego.objetivo.x},${juego.objetivo.y}`;
            document.getElementById('tiempo').textContent = formatearTiempo(juego.tiempoRestante);
        }

        function dibujar() {
            ctx.fillStyle = '#9BBC0F';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const escala = 25;
            const centro = 150;

            // Cuadr√≠cula
            ctx.strokeStyle = '#0F380F';
            ctx.lineWidth = 1;
            for (let i = -5; i <= 5; i++) {
                ctx.lineWidth = i === 0 ? 2 : 1;
                
                ctx.beginPath();
                ctx.moveTo(centro + i * escala, 25);
                ctx.lineTo(centro + i * escala, 275);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(25, centro - i * escala);
                ctx.lineTo(275, centro - i * escala);
                ctx.stroke();
            }

            // N√∫meros
            ctx.fillStyle = '#0F380F';
            ctx.font = 'bold 10px "Courier New"';
            ctx.textAlign = 'center';
            for (let i = -5; i <= 5; i++) {
                if (i !== 0) {
                    ctx.fillText(i, centro + i * escala, centro + 15);
                    ctx.fillText(i, centro - 15, centro - i * escala + 4);
                }
            }

            // L√≠neas de ayuda
            if (juego.mostrarAyuda) {
                ctx.strokeStyle = '#306230';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 3]);
                
                const dx = juego.objetivo.x - juego.posicion.x;
                const dy = juego.objetivo.y - juego.posicion.y;
                
                if (dx !== 0) {
                    ctx.beginPath();
                    ctx.moveTo(centro + juego.posicion.x * escala, centro - juego.posicion.y * escala);
                    ctx.lineTo(centro + juego.objetivo.x * escala, centro - juego.posicion.y * escala);
                    ctx.stroke();
                }
                
                if (dy !== 0) {
                    ctx.beginPath();
                    ctx.moveTo(centro + juego.objetivo.x * escala, centro - juego.posicion.y * escala);
                    ctx.lineTo(centro + juego.objetivo.x * escala, centro - juego.objetivo.y * escala);
                    ctx.stroke();
                }
                
                ctx.setLineDash([]);
            }

            // Rastro
            juego.movimientos.forEach((mov, idx) => {
                const opacity = 0.2 + (idx / juego.movimientos.length) * 0.3;
                ctx.fillStyle = `rgba(15, 56, 15, ${opacity})`;
                ctx.beginPath();
                ctx.arc(centro + mov.x * escala, centro - mov.y * escala, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // Enemigos
            juego.enemigos.forEach(enemigo => {
                if (!enemigo.activo) return;
                
                ctx.fillStyle = 'rgba(15, 56, 15, 0.2)';
                ctx.beginPath();
                ctx.arc(centro + enemigo.x * escala, centro - enemigo.y * escala, 12, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemigo.tipo.emoji, centro + enemigo.x * escala, centro - enemigo.y * escala);
            });

            // Objetivo (estrella)
            ctx.fillStyle = 'rgba(15, 56, 15, 0.2)';
            ctx.beginPath();
            ctx.arc(centro + juego.objetivo.x * escala, centro - juego.objetivo.y * escala, 14, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = '18px Arial';
            ctx.fillText('‚≠ê', centro + juego.objetivo.x * escala, centro - juego.objetivo.y * escala);

            // Jugador
            ctx.fillStyle = 'rgba(15, 56, 15, 0.3)';
            ctx.beginPath();
            ctx.arc(centro + juego.posicion.x * escala, centro - juego.posicion.y * escala, 12, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#0F380F';
            ctx.beginPath();
            ctx.arc(centro + juego.posicion.x * escala, centro - juego.posicion.y * escala, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = '16px Arial';
            ctx.fillText('üéØ', centro + juego.posicion.x * escala, centro - juego.posicion.y * escala);
        }

        // Soporte t√°ctil
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            if (!juego.juegoActivo) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (Math.abs(diffX) > 30) {
                    moverJugador(diffX > 0 ? 1 : -1, 0);
                }
            } else {
                if (Math.abs(diffY) > 30) {
                    moverJugador(0, diffY > 0 ? -1 : 1);
                }
            }
        });

        // Prevenir zoom en iOS
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });

        // Inicializar
        window.addEventListener('load', () => {
            dibujar();
        });
    </script>
</body>
</html>
